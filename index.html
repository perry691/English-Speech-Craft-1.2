<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语演讲稿批改助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 添加生成docx所需的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.6/docxtemplater.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3498db',
                        secondary: '#f5f5f7',
                        neutral: '#86868b',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-shadow {
                box-shadow: 0 4px 14px rgba(52, 152, 219, 0.3);
            }
            .btn-hover {
                transition: all 0.3s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 18px rgba(52, 152, 219, 0.4);
            }
            .btn-active {
                transform: translateY(1px);
                box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <!-- 页面容器 -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 标题区域 -->
        <header class="text-center mb-10">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-semibold text-gray-900 mb-2">英语演讲稿批改助手</h1>
            <p class="text-neutral text-lg">专业的演讲稿分析与优化建议</p>
        </header>

        <!-- 主要内容区域 -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 输入区域 -->
            <section class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-medium mb-4 flex items-center">
                    <i class="fa fa-pencil-square-o text-primary mr-2"></i>输入演讲稿
                </h2>
                <div class="mb-4">
                    <textarea 
                        id="speechInput" 
                        class="w-full h-64 p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all resize-none"
                        placeholder="请在此输入您的英语演讲稿..."
                    ></textarea>
                </div>
                
                <!-- 按钮区域 -->
                <div class="flex flex-wrap gap-4 mt-6">
                    <button 
                        id="resetBtn" 
                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg btn-shadow btn-hover flex-1 sm:flex-none"
                    >
                        <i class="fa fa-refresh mr-2"></i>重置
                    </button>
                    <button 
                        id="checkBtn" 
                        class="px-6 py-3 bg-primary text-white rounded-lg btn-shadow btn-hover flex-1 sm:flex-none"
                    >
                        <i class="fa fa-check mr-2"></i>开始批改
                    </button>
                    <button 
                        id="exportBtn" 
                        class="px-6 py-3 bg-gray-800 text-white rounded-lg btn-shadow btn-hover flex-1 sm:flex-none"
                    >
                        <i class="fa fa-download mr-2"></i>导出报告
                    </button>
                </div>
            </section>

            <!-- 反馈区域 -->
            <section class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-medium mb-4 flex items-center">
                    <i class="fa fa-comments-o text-primary mr-2"></i>批改反馈
                </h2>
                <div id="feedbackArea" class="min-h-64 p-4 border border-gray-200 rounded-lg">
                    <div class="text-neutral text-center py-12">
                        <i class="fa fa-file-text-o text-4xl mb-4 opacity-30"></i>
                        <p>请输入演讲稿并点击"开始批改"按钮获取反馈</p>
                    </div>
                </div>

                <!-- 追问区域 -->
                <div id="followUpArea" class="mt-6 hidden">
                    <h3 class="text-lg font-medium mb-3">您可能想了解：</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button class="followUpQuestion px-4 py-2 border border-gray-200 rounded-lg text-left hover:bg-secondary transition-colors">
                            如何提高演讲稿的逻辑性？
                        </button>
                        <button class="followUpQuestion px-4 py-2 border border-gray-200 rounded-lg text-left hover:bg-secondary transition-colors">
                            如何让语言表达更地道？
                        </button>
                        <button class="followUpQuestion px-4 py-2 border border-gray-200 rounded-lg text-left hover:bg-secondary transition-colors">
                            演讲开头有哪些好的技巧？
                        </button>
                        <button class="followUpQuestion px-4 py-2 border border-gray-200 rounded-lg text-left hover:bg-secondary transition-colors">
                            如何增强演讲稿的思辨性？
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- 页脚 -->
        <footer class="mt-16 text-center text-neutral text-sm">
            <p>本工具仅供学习和教学使用，未经授权不得用于商业用途，评测结果仅供参考。</p>
            <p class="mt-2">Powered by Github. Copyright@PERRY.</p>
        </footer>
    </div>

    <script>
        // 后端API地址 - 部署后需要修改为实际的Vercel地址
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : 'https://你的vercel应用地址.vercel.app/api';

        document.addEventListener('DOMContentLoaded', function() {
            const speechInput = document.getElementById('speechInput');
            const feedbackArea = document.getElementById('feedbackArea');
            const followUpArea = document.getElementById('followUpArea');
            const resetBtn = document.getElementById('resetBtn');
            const checkBtn = document.getElementById('checkBtn');
            const exportBtn = document.getElementById('exportBtn');
            const followUpQuestions = document.querySelectorAll('.followUpQuestion');

            // 存储实际的反馈数据，用于导出
            let feedbackData = null;
            let originalSpeech = '';

            // 按钮点击效果
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mousedown', function() {
                    this.classList.add('btn-active');
                });
                button.addEventListener('mouseup', function() {
                    this.classList.remove('btn-active');
                });
                button.addEventListener('mouseleave', function() {
                    this.classList.remove('btn-active');
                });
            });

            // 重置按钮
            resetBtn.addEventListener('click', function() {
                speechInput.value = '';
                feedbackArea.innerHTML = `
                    <div class="text-neutral text-center py-12">
                        <i class="fa fa-file-text-o text-4xl mb-4 opacity-30"></i>
                        <p>请输入演讲稿并点击"开始批改"按钮获取反馈</p>
                    </div>
                `;
                followUpArea.classList.add('hidden');
                feedbackData = null;
                originalSpeech = '';
            });

            // 开始批改按钮
            checkBtn.addEventListener('click', async function() {
                const speechText = speechInput.value.trim();
                originalSpeech = speechText;
                
                if (!speechText) {
                    feedbackArea.innerHTML = `
                        <div class="text-red-500 text-center py-12">
                            <i class="fa fa-exclamation-circle text-4xl mb-4"></i>
                            <p>请先输入英语演讲稿内容</p>
                        </div>
                    `;
                    return;
                }

                // 显示加载状态
                feedbackArea.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fa fa-spinner fa-spin text-4xl mb-4 text-primary"></i>
                        <p>正在批改中，请稍候...</p>
                    </div>
                `;

                try {
                    // 调用真实的后端API
                    const response = await fetch(`${API_BASE_URL}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            message: speechText,
                            questionType: 'comprehensive'
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }

                    if (data.success) {
                        // 存储反馈数据
                        feedbackData = data;
                        // 显示反馈结果
                        displayFeedback(data);
                        followUpArea.classList.remove('hidden');
                    } else {
                        throw new Error(data.error || '批改失败');
                    }

                } catch (error) {
                    console.error('批改请求失败:', error);
                    feedbackArea.innerHTML = `
                        <div class="text-red-500 text-center py-12">
                            <i class="fa fa-exclamation-circle text-4xl mb-4"></i>
                            <p>批改失败: ${error.message}</p>
                            <p class="text-sm mt-2">请检查网络连接或稍后重试</p>
                        </div>
                    `;
                }
            });

            // 显示反馈结果的函数
            function displayFeedback(data) {
                if (data.rawResponse) {
                    // 直接显示AI的原始回复
                    feedbackArea.innerHTML = `
                        <div class="space-y-6">
                            <div class="bg-white p-4 rounded-lg">
                                <div class="prose max-w-none">
                                    ${formatAIResponse(data.rawResponse)}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // 如果没有原始回复，显示错误
                    feedbackArea.innerHTML = `
                        <div class="text-red-500 text-center py-12">
                            <i class="fa fa-exclamation-circle text-4xl mb-4"></i>
                            <p>未能获取到有效的反馈内容</p>
                        </div>
                    `;
                }
            }

            // 格式化AI回复的文本
            function formatAIResponse(text) {
                // 将文本转换为HTML格式
                let html = text
                    .replace(/\n\n+/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/(\d+\.)\s/g, '<strong>$1</strong> ')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');

                // 添加一些基本的样式类
                html = html
                    .replace(/<p>/g, '<p class="mb-4">')
                    .replace(/<strong>/g, '<strong class="text-gray-900">')
                    .replace(/<h3>/g, '<h3 class="text-lg font-semibold mb-3 mt-6 text-primary">')
                    .replace(/<h4>/g, '<h4 class="font-semibold mb-2 mt-4 text-gray-900">');

                return `<p>${html}</p>`;
            }

            // 导出报告按钮
            exportBtn.addEventListener('click', function() {
                if (!feedbackData || !originalSpeech) {
                    alert('请先完成演讲稿批改');
                    return;
                }

                try {
                    // 创建报告内容
                    const reportContent = `
英语演讲稿批改报告
===============================

原始演讲稿：
${originalSpeech}

批改反馈：
${feedbackData.rawResponse}

生成时间：${new Date().toLocaleString('zh-CN')}
                    `.trim();

                    // 创建Blob对象
                    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                    
                    // 使用FileSaver保存文件
                    saveAs(blob, '英语演讲稿批改报告.txt');

                } catch (error) {
                    console.error('导出失败:', error);
                    alert('导出报告时出错，请重试');
                }
            });

            // 追问问题点击事件
            followUpQuestions.forEach(question => {
                question.addEventListener('click', async function() {
                    const questionText = this.textContent.trim();
                    
                    if (!originalSpeech) {
                        alert('请先完成演讲稿批改');
                        return;
                    }

                    // 显示加载状态
                    const loadingElement = document.createElement('div');
                    loadingElement.className = 'mt-6 p-4 bg-secondary rounded-lg';
                    loadingElement.innerHTML = `
                        <div class="text-center">
                            <i class="fa fa-spinner fa-spin text-primary mr-2"></i>
                            正在生成回答...
                        </div>
                    `;
                    feedbackArea.appendChild(loadingElement);

                    try {
                        // 调用追问API
                        const response = await fetch(`${API_BASE_URL}/chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                message: originalSpeech,
                                followUpQuestion: questionText
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || `HTTP error! status: ${response.status}`);
                        }

                        if (data.success) {
                            // 移除加载状态
                            feedbackArea.removeChild(loadingElement);

                            // 显示追问答案
                            const answerElement = document.createElement('div');
                            answerElement.className = 'mt-6 p-4 bg-secondary rounded-lg';
                            answerElement.innerHTML = `
                                <h4 class="font-semibold mb-3 text-primary">Q: ${questionText}</h4>
                                <div class="prose max-w-none text-gray-700">
                                    ${formatAIResponse(data.rawResponse || data.answer)}
                                </div>
                            `;
                            
                            feedbackArea.appendChild(answerElement);
                            
                            // 保存到反馈数据中
                            if (!feedbackData.followUpContent) {
                                feedbackData.followUpContent = [];
                            }
                            feedbackData.followUpContent.push({
                                question: questionText,
                                answer: data.rawResponse || data.answer
                            });

                            // 滚动到最新内容
                            answerElement.scrollIntoView({ behavior: 'smooth' });
                        } else {
                            throw new Error(data.error || '生成回答失败');
                        }

                    } catch (error) {
                        console.error('追问请求失败:', error);
                        // 更新加载状态为错误
                        loadingElement.innerHTML = `
                            <div class="text-red-500">
                                <i class="fa fa-exclamation-circle mr-2"></i>
                                回答生成失败: ${error.message}
                            </div>
                        `;
                    }
                });
            });
        });
    </script>
</body>
</html>
